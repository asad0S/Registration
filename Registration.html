<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø³ÛŒØ³ØªÙ… Ø«Ø¨Øª Ø¯Ø±Ø®ÙˆØ§Ø³Øª ÙˆÛŒØ²Ø§</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
<script src="https://unpkg.com/jalaali-js/dist/jalaali.min.js"></script>
<style>
* {margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;}
body {background:#f8f9fa;color:#333;line-height:1.6;}
.container {width:90%;max-width:900px;margin:2rem auto;padding:1rem;}
h2 {color:#1a5f7a;text-align:center;margin-bottom:1.5rem;}
form {background:white;padding:2rem;border-radius:10px;box-shadow:0 5px 15px rgba(0,0,0,0.05);}
.form-group {margin-bottom:1rem;}
label {display:block;margin-bottom:0.5rem;font-weight:500;color:#444;}
input, textarea, select {width:100%;padding:0.7rem;border:1px solid #ddd;border-radius:5px;font-size:1rem;}
input:focus, textarea:focus, select:focus {outline:none;border-color:#1a5f7a;box-shadow:0 0 0 2px rgba(26,95,122,0.1);}
button {background-color:#1a5f7a;color:white;border:none;padding:0.5rem 1rem;font-size:0.9rem;border-radius:5px;cursor:pointer;transition:0.3s;margin-top:5px;}
button:hover {background-color:#154b61;}
.result {margin-top:2rem;text-align:center;}
.qr-container {margin-top:1rem;}
.otp-code {font-size:1.5rem;color:#1a5f7a;font-weight:bold;margin-top:1rem;}
.user-card {border:1px solid #ddd;padding:10px;display:grid;grid-template-columns:1fr 1fr;gap:5px;position:relative;border-radius:5px;cursor:pointer;margin-bottom:10px;background:white;}
.user-fullName {grid-column: 1 / -1; margin-top:25px; font-weight:bold; color:#1a5f7a;}
.show-qr-btn {position:absolute;top:10px;right:70px;background:#ffcc00;color:#1a5f7a;font-weight:bold;padding:2px 6px;font-size:0.8rem;border-radius:3px;}
.delete-btn {position:absolute;top:10px;right:10px;background:#ff4d4f;color:white;font-weight:bold;padding:2px 6px;font-size:0.8rem;border-radius:3px;}
.edit-btn {position:absolute;top:10px;right:130px;background:#28a745;color:white;font-weight:bold;padding:2px 6px;font-size:0.8rem;border-radius:3px;}
.modal, .edit-modal {display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);align-items:center;justify-content:center;z-index:1000;}
.modal-content, .edit-modal-content {background:white;padding:2rem;border-radius:10px;text-align:center;width:90%;max-width:400px;}
.edit-form {display:flex;flex-direction:column;gap:1rem;}
.edit-form input, .edit-form textarea {width:100%;}
.close-btn {cursor:pointer;background:#1a5f7a;color:white;padding:0.3rem 0.6rem;border:none;border-radius:5px;margin-top:1rem;}
.filter-controls {background:white;padding:1.5rem;border-radius:10px;box-shadow:0 3px 10px rgba(0,0,0,0.05);margin-top:2rem;}
.filter-controls h3 {color:#1a5f7a;margin-bottom:1rem;}
.search-box {display:flex;gap:10px;margin-bottom:1rem;}
.search-box input {flex:1;}
.filter-buttons {display:flex;gap:10px;flex-wrap:wrap;}
.filter-buttons button {flex:1;min-width:150px;}
.empty-message {text-align:center;padding:2rem;color:#666;background:white;border-radius:10px;margin-top:1rem;}
.info-label {background:#e8f4fc;color:#1a5f7a;padding:3px 8px;border-radius:3px;font-size:0.85rem;margin-left:5px;}
.active-filter {background-color:#154b61 !important;color:white !important;box-shadow:0 2px 5px rgba(0,0,0,0.2);}
.filter-status {display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;padding:0.5rem;background:#f0f8ff;border-radius:5px;}
.filter-title {color:#1a5f7a;font-weight:bold;}
.filter-count {background:#1a5f7a;color:white;padding:3px 10px;border-radius:15px;font-size:0.9rem;}
</style>
</head>
<body>
<div class="container">
    <h2>Ø³ÛŒØ³ØªÙ… Ø«Ø¨Øª Ø¯Ø±Ø®ÙˆØ§Ø³Øª ÙˆÛŒØ²Ø§</h2>
    <form id="visaForm">
        <div class="form-group"><label>Ø§Ø³Ù… Ú©Ø§Ù…Ù„</label><input type="text" id="fullName" name="fullName" required></div>
        <div class="form-group"><label>Ø§Ø³Ù… Ù¾Ø¯Ø±</label><input type="text" id="fatherName" name="fatherName" required></div>
        <div class="form-group"><label>Ù…Ø¨Ù„Øº (Ø§ÙØºØ§Ù†ÛŒ)</label><input type="number" id="amount" name="amount" required></div>
        <div class="form-group"><label>Ø±Ø³ÛŒØ¯ (Ø§ÙØºØ§Ù†ÛŒ)</label><input type="number" id="receipt" name="receipt" required></div>
        <div class="form-group"><label>Ø¨Ø§Ù‚ÛŒ Ù…Ø§Ù†Ø¯Ù‡ (Ø§ÙØºØ§Ù†ÛŒ)</label><input type="number" id="remaining" name="remaining" readonly></div>
        <div class="form-group"><label>Ù†ÙˆØ¹ ÙˆÛŒØ²Ø§</label><textarea id="visaType" name="visaType" placeholder="Ù†ÙˆØ¹ ÙˆÛŒØ²Ø§ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯" rows="2" required></textarea></div>
        <div class="form-group"><label>ÙˆØ¶ÛŒØ¹Øª ÙØ¹Ù„ÛŒ</label><textarea id="status" name="status" placeholder="ÙˆØ¶ÛŒØ¹Øª ÙØ¹Ù„ÛŒ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯" rows="2" required></textarea></div>
        <div class="form-group"><label>ØªØ§Ø±ÛŒØ® ØªØ­ÙˆÛŒÙ„ Ø¯Ø§Ø¯Ù‡</label><input type="text" id="deliveryDate" name="deliveryDate" readonly></div>
        <button type="submit">Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø±Ø®ÙˆØ§Ø³Øª</button>
    </form>

    <div class="result" id="result">
        <div class="qr-container" id="qrContainer"></div>
        <div class="otp-code" id="otpCode"></div>
    </div>

    <div class="filter-controls" id="filterControls">
        <h3>Ù…Ø¯ÛŒØ±ÛŒØª Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§</h3>
        
        <div class="filter-status">
            <div class="filter-title" id="currentFilterTitle">Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ 10 Ø±ÙˆØ² Ø§Ø®ÛŒØ±</div>
            <div class="filter-count" id="currentFilterCount">0 Ù…ÙˆØ±Ø¯</div>
        </div>
        
        <div class="search-box">
            <input type="text" id="searchInput" placeholder="Ø¬Ø³ØªØ¬Ùˆ Ø¨Ø§ Ù†Ø§Ù… Ú©Ø§Ù…Ù„ ÛŒØ§ Ú©Ø¯ OTP">
            <button id="searchBtn">ğŸ” Ø¬Ø³ØªØ¬Ùˆ</button>
        </div>
        
        <div class="filter-buttons">
            <button id="showRecentBtn" class="active-filter">Û±Û° Ø±ÙˆØ² Ø§Ø®ÛŒØ±</button>
            <button id="showAllBtn">Ù‡Ù…Ù‡ Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§</button>
        </div>
    </div>

    <div id="usersListDiv" style="margin-top:1rem;"></div>
</div>

<div class="modal" id="qrModal">
  <div class="modal-content">
    <canvas id="modalQR"></canvas>
    <button class="close-btn" id="closeModal">Ø¨Ø³ØªÙ†</button>
  </div>
</div>

<div class="edit-modal" id="editModal">
  <div class="edit-modal-content">
    <h3 style="color:#1a5f7a;margin-bottom:1rem;">ÙˆÛŒØ±Ø§ÛŒØ´ Ø§Ø·Ù„Ø§Ø¹Ø§Øª</h3>
    <form class="edit-form" id="editForm">
      <input type="text" id="editFullName" required placeholder="Ø§Ø³Ù… Ú©Ø§Ù…Ù„">
      <input type="text" id="editFatherName" required placeholder="Ø§Ø³Ù… Ù¾Ø¯Ø±">
      <input type="number" id="editAmount" required placeholder="Ù…Ø¨Ù„Øº">
      <input type="number" id="editReceipt" required placeholder="Ø±Ø³ÛŒØ¯">
      <input type="number" id="editRemaining" readonly placeholder="Ø¨Ø§Ù‚ÛŒ Ù…Ø§Ù†Ø¯Ù‡">
      <textarea id="editVisaType" required rows="2" placeholder="Ù†ÙˆØ¹ ÙˆÛŒØ²Ø§"></textarea>
      <textarea id="editStatus" required rows="2" placeholder="ÙˆØ¶ÛŒØ¹Øª ÙØ¹Ù„ÛŒ"></textarea>
      <input type="text" id="editDeliveryDate" readonly placeholder="ØªØ§Ø±ÛŒØ® ØªØ­ÙˆÛŒÙ„ Ø¯Ø§Ø¯Ù‡">
      <button type="submit">Ø°Ø®ÛŒØ±Ù‡ ØªØºÛŒÛŒØ±Ø§Øª</button>
    </form>
    <button class="close-btn" id="closeEditModal">Ø¨Ø³ØªÙ†</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, doc, deleteDoc, updateDoc, query, where, Timestamp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-analytics.js";

const firebaseConfig = {
  apiKey: "AIzaSyCHjDCV5G4SqXBVayBSQKu0w7ahl-iKK9s",
  authDomain: "search-system-d27b7.firebaseapp.com",
  projectId: "search-system-d27b7",
  storageBucket: "search-system-d27b7.firebasestorage.app",
  messagingSenderId: "928320892642",
  appId: "1:928320892642:web:56263d08783990405738bb",
  measurementId: "G-HBW40SPG7H"
};

const app = initializeApp(firebaseConfig);
const analytics = getAnalytics(app);
const db = getFirestore(app);

// ØªØ§Ø±ÛŒØ® Ø´Ù…Ø³ÛŒ Ø§Ù…Ø±ÙˆØ²
function getPersianDate(){
  const g = new Date();
  const j = jalaali.toJalaali(g.getFullYear(), g.getMonth()+1, g.getDate());
  return `${j.jy}/${j.jm}/${j.jd}`;
}
document.getElementById('deliveryDate').value = getPersianDate();

const visaForm = document.getElementById('visaForm');
const qrContainer = document.getElementById('qrContainer');
const otpCodeEl = document.getElementById('otpCode');
const usersListDiv = document.getElementById('usersListDiv');
const searchInput = document.getElementById('searchInput');
const searchBtn = document.getElementById('searchBtn');
const showRecentBtn = document.getElementById('showRecentBtn');
const showAllBtn = document.getElementById('showAllBtn');
const qrModal = document.getElementById('qrModal');
const modalQR = document.getElementById('modalQR');
const closeModal = document.getElementById('closeModal');
const editModal = document.getElementById('editModal');
const closeEditModal = document.getElementById('closeEditModal');
const editForm = document.getElementById('editForm');
const currentFilterTitle = document.getElementById('currentFilterTitle');
const currentFilterCount = document.getElementById('currentFilterCount');

let editDocId = null;
let allUsers = [];
let currentFilter = 'recent'; // Ù¾ÛŒØ´â€ŒÙØ±Ø¶: 10 Ø±ÙˆØ² Ø§Ø®ÛŒØ±

// ØªØ¨Ø¯ÛŒÙ„ ØªØ§Ø±ÛŒØ® Ø´Ù…Ø³ÛŒ Ø¨Ù‡ Ù…ÛŒÙ„Ø§Ø¯ÛŒ Ø¨Ø±Ø§ÛŒ Ù…Ø­Ø§Ø³Ø¨Ø§Øª
function persianToGregorian(persianDate) {
  const parts = persianDate.split('/');
  if (parts.length !== 3) return new Date();
  
  const jy = parseInt(parts[0]);
  const jm = parseInt(parts[1]);
  const jd = parseInt(parts[2]);
  
  const g = jalaali.toGregorian(jy, jm, jd);
  return new Date(g.gy, g.gm - 1, g.gd);
}

// Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø®ÙˆØ¯Ú©Ø§Ø± Ø¨Ø§Ù‚ÛŒ Ù…Ø§Ù†Ø¯Ù‡
function calculateRemaining(){
  const amount = parseFloat(document.getElementById('amount').value) || 0;
  const receipt = parseFloat(document.getElementById('receipt').value) || 0;
  document.getElementById('remaining').value = amount - receipt;
}
document.getElementById('amount').addEventListener('input', calculateRemaining);
document.getElementById('receipt').addEventListener('input', calculateRemaining);

// Ø«Ø¨Øª ÙØ±Ù…
visaForm.addEventListener('submit', async e=>{
  e.preventDefault();
  const data = {
    fullName: document.getElementById('fullName').value,
    fatherName: document.getElementById('fatherName').value,
    amount: document.getElementById('amount').value,
    receipt: document.getElementById('receipt').value,
    remaining: document.getElementById('remaining').value,
    visaType: document.getElementById('visaType').value,
    status: document.getElementById('status').value,
    deliveryDate: document.getElementById('deliveryDate').value,
    timestamp: Timestamp.fromDate(new Date())
  };
  const otp = Math.floor(1000 + Math.random()*9000);
  data.otp = otp;

  otpCodeEl.textContent = 'Ú©Ø¯ OTP Ø´Ù…Ø§: ' + otp;
  qrContainer.innerHTML = '';
  const qr = new QRious({element: document.createElement('canvas'), value: JSON.stringify(data), size:200});
  qrContainer.appendChild(qr.element);

  try { 
    await addDoc(collection(db, "visaRequests"), data); 
    
    // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…Ø¬Ø¯Ø¯ Ù„ÛŒØ³Øªâ€ŒÙ‡Ø§
    await loadAllUsers();
    if (currentFilter === 'recent') {
      await showRecentUsers();
    } else {
      displayUsers(allUsers, 'Ù‡Ù…Ù‡ Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§');
    }
  }
  catch(err){ 
    console.error(err); 
    alert('Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ø§Ø·Ù„Ø§Ø¹Ø§Øª!');
  }

  visaForm.reset();
  document.getElementById('deliveryDate').value = getPersianDate();
});

// Ù†Ù…Ø§ÛŒØ´ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†
async function displayUsers(users = null, filterType = 'Û±Û° Ø±ÙˆØ² Ø§Ø®ÛŒØ±', filterName = 'recent') {
  usersListDiv.innerHTML = '';
  currentFilter = filterName;
  
  if (!users) {
    usersListDiv.innerHTML = '<div class="empty-message">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª...</div>';
    return;
  }
  
  // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ÙˆØ¶Ø¹ÛŒØª ÙÛŒÙ„ØªØ±
  currentFilterTitle.textContent = filterType;
  currentFilterCount.textContent = `${users.length} Ù…ÙˆØ±Ø¯`;
  
  // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù„ÛŒ Ú©Ù„Ø§Ø³â€ŒÙ‡Ø§ÛŒ ÙØ¹Ø§Ù„ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§
  showRecentBtn.classList.remove('active-filter');
  showAllBtn.classList.remove('active-filter');
  
  if (filterName === 'recent') {
    showRecentBtn.classList.add('active-filter');
  } else if (filterName === 'all') {
    showAllBtn.classList.add('active-filter');
  } else if (filterName === 'search') {
    showRecentBtn.classList.remove('active-filter');
    showAllBtn.classList.remove('active-filter');
  }
  
  if (users.length === 0) {
    usersListDiv.innerHTML = `<div class="empty-message">Ù…ÙˆØ±Ø¯ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯. <span class="info-label">${filterType}</span></div>`;
    return;
  }
  
  users.forEach(userData => {
    const d = userData.data;
    const div = document.createElement('div');
    div.classList.add('user-card');
    div.innerHTML = `
      <button class="edit-btn">ÙˆÛŒØ±Ø§ÛŒØ´</button>
      <button class="show-qr-btn">Ø¨Ø§Ø±Ú©Ø¯</button>
      <button class="delete-btn">Ø­Ø°Ù</button>
      <div class="user-fullName">${d.fullName} <span style="font-size:0.8rem; color:#666;"></span></div>
      <div><b>Ø§Ø³Ù… Ù¾Ø¯Ø±:</b></div><div>${d.fatherName}</div>
      <div><b>Ù…Ø¨Ù„Øº:</b></div><div>${d.amount} Ø§ÙØºØ§Ù†ÛŒ</div>
      <div><b>Ø±Ø³ÛŒØ¯:</b></div><div>${d.receipt} Ø§ÙØºØ§Ù†ÛŒ</div>
      <div><b>Ø¨Ø§Ù‚ÛŒ Ù…Ø§Ù†Ø¯Ù‡:</b></div><div>${d.remaining} Ø§ÙØºØ§Ù†ÛŒ</div>
      <div><b>Ù†ÙˆØ¹ ÙˆÛŒØ²Ø§:</b></div><div>${d.visaType}</div>
      <div><b>ÙˆØ¶ÛŒØ¹Øª ÙØ¹Ù„ÛŒ:</b></div><div>${d.status}</div>
      <div><b>ØªØ§Ø±ÛŒØ® ØªØ­ÙˆÛŒÙ„:</b></div><div>${d.deliveryDate}</div>
      <div><b>Ú©Ø¯ Ø±Ù‡Ú¯ÛŒØ±ÛŒ:</b></div><div><strong>${d.otp}</strong></div>
    `;
    usersListDiv.appendChild(div);

    div.querySelector('.show-qr-btn').addEventListener('click', ()=>{
      qrModal.style.display='flex';
      new QRious({element:modalQR, value:JSON.stringify(d), size:250});
    });

    div.querySelector('.delete-btn').addEventListener('click', async ()=>{
      if(confirm(`Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø¯Ø±Ø®ÙˆØ§Ø³Øª ${d.fullName} Ø¨Ø§ Ú©Ø¯ ${d.otp} Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ`)){
        try {
          await deleteDoc(doc(db,"visaRequests",userData.id));
          div.remove();
          // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù„ÛŒØ³Øª
          allUsers = allUsers.filter(u => u.id !== userData.id);
          
          // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù†Ù…Ø§ÛŒØ´ Ø¨Ø± Ø§Ø³Ø§Ø³ ÙÛŒÙ„ØªØ± ÙØ¹Ù„ÛŒ
          if (currentFilter === 'recent') {
            await showRecentUsers();
          } else if (currentFilter === 'all') {
            displayUsers(allUsers, 'Ù‡Ù…Ù‡ Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§', 'all');
          } else if (currentFilter === 'search') {
            searchUsers();
          }
        } catch (error) {
          alert('Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù Ø§Ø·Ù„Ø§Ø¹Ø§Øª!');
        }
      }
    });

    div.querySelector('.edit-btn').addEventListener('click', ()=>{
      editModal.style.display='flex';
      editForm.editFullName.value = d.fullName;
      editForm.editFatherName.value = d.fatherName;
      editForm.editAmount.value = d.amount;
      editForm.editReceipt.value = d.receipt;
      editForm.editRemaining.value = d.remaining;
      editForm.editVisaType.value = d.visaType;
      editForm.editStatus.value = d.status;
      editForm.editDeliveryDate.value = d.deliveryDate;
      editDocId = userData.id;
    });
  });
}

// Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù‡Ù…Ù‡ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†
async function loadAllUsers() {
  const snapshot = await getDocs(collection(db, "visaRequests"));
  allUsers = snapshot.docs.map(doc => ({ id: doc.id, data: doc.data() }));
  return allUsers;
}

// Ù†Ù…Ø§ÛŒØ´ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† 10 Ø±ÙˆØ² Ø§Ø®ÛŒØ±
async function showRecentUsers() {
  const tenDaysAgo = new Date();
  tenDaysAgo.setDate(tenDaysAgo.getDate() - 10);
  
  const recentUsers = allUsers.filter(user => {
    // Ø§Ú¯Ø± timestamp ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯ØŒ Ø§Ø² Ø¢Ù† Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†
    if (user.data.timestamp) {
      const userDate = user.data.timestamp.toDate();
      return userDate >= tenDaysAgo;
    }
    
    // Ø§Ú¯Ø± timestamp ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯ØŒ Ø§Ø² ØªØ§Ø±ÛŒØ® Ø´Ù…Ø³ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†
    try {
      const userDate = persianToGregorian(user.data.deliveryDate);
      return userDate >= tenDaysAgo;
    } catch {
      return false;
    }
  });
  
  // Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ ØªØ§Ø±ÛŒØ® (Ø¬Ø¯ÛŒØ¯ØªØ±ÛŒÙ† Ø§ÙˆÙ„)
  recentUsers.sort((a, b) => {
    const dateA = a.data.timestamp ? a.data.timestamp.toDate() : persianToGregorian(a.data.deliveryDate);
    const dateB = b.data.timestamp ? b.data.timestamp.toDate() : persianToGregorian(b.data.deliveryDate);
    return dateB - dateA;
  });
  
  displayUsers(recentUsers, 'Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ Û±Û° Ø±ÙˆØ² Ø§Ø®ÛŒØ±', 'recent');
}

// Ø¬Ø³ØªØ¬Ùˆ Ø¯Ø± Ú©Ø§Ø±Ø¨Ø±Ø§Ù†
function searchUsers() {
  const searchTerm = searchInput.value.trim().toLowerCase();
  
  if (!searchTerm) {
    // Ø§Ú¯Ø± Ø¬Ø³ØªØ¬Ùˆ Ø®Ø§Ù„ÛŒ Ø¨ÙˆØ¯ØŒ Ø¨Ø±Ú¯Ø±Ø¯ Ø¨Ù‡ ÙÛŒÙ„ØªØ± Ù‚Ø¨Ù„ÛŒ
    if (currentFilter === 'recent') {
      showRecentUsers();
    } else {
      displayUsers(allUsers, 'Ù‡Ù…Ù‡ Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§', 'all');
    }
    return;
  }
  
  const filteredUsers = allUsers.filter(user => {
    const fullNameMatch = user.data.fullName && user.data.fullName.toLowerCase().includes(searchTerm);
    const otpMatch = user.data.otp && user.data.otp.toString().includes(searchTerm);
    
    return fullNameMatch || otpMatch;
  });
  
  // Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ Ù†ØªØ§ÛŒØ¬ Ø¬Ø³ØªØ¬Ùˆ
  filteredUsers.sort((a, b) => {
    const dateA = a.data.timestamp ? a.data.timestamp.toDate() : persianToGregorian(a.data.deliveryDate);
    const dateB = b.data.timestamp ? b.data.timestamp.toDate() : persianToGregorian(b.data.deliveryDate);
    return dateB - dateA;
  });
  
  displayUsers(filteredUsers, `Ù†ØªØ§ÛŒØ¬ Ø¬Ø³ØªØ¬Ùˆ: "${searchTerm}"`, 'search');
}

// Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§
showRecentBtn.addEventListener('click', async () => {
  if (allUsers.length > 0) {
    await showRecentUsers();
  } else {
    await loadAllUsers();
    await showRecentUsers();
  }
});

showAllBtn.addEventListener('click', async () => {
  if (allUsers.length === 0) {
    await loadAllUsers();
  }
  // Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ Ù‡Ù…Ù‡ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¨Ø± Ø§Ø³Ø§Ø³ ØªØ§Ø±ÛŒØ® (Ø¬Ø¯ÛŒØ¯ØªØ±ÛŒÙ† Ø§ÙˆÙ„)
  const sortedUsers = [...allUsers].sort((a, b) => {
    const dateA = a.data.timestamp ? a.data.timestamp.toDate() : persianToGregorian(a.data.deliveryDate);
    const dateB = b.data.timestamp ? b.data.timestamp.toDate() : persianToGregorian(b.data.deliveryDate);
    return dateB - dateA;
  });
  displayUsers(sortedUsers, 'Ù‡Ù…Ù‡ Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§', 'all');
});

searchBtn.addEventListener('click', searchUsers);

searchInput.addEventListener('keyup', (e) => {
  if (e.key === 'Enter') {
    searchUsers();
  }
});

// Ø°Ø®ÛŒØ±Ù‡ ÙˆÛŒØ±Ø§ÛŒØ´
editForm.addEventListener('submit', async e=>{
  e.preventDefault();
  if(!editDocId) return;
  
  const updatedData = {
    fullName: editForm.editFullName.value,
    fatherName: editForm.editFatherName.value,
    amount: editForm.editAmount.value,
    receipt: editForm.editReceipt.value,
    remaining: editForm.editRemaining.value,
    visaType: editForm.editVisaType.value,
    status: editForm.editStatus.value,
    deliveryDate: editForm.editDeliveryDate.value,
    timestamp: Timestamp.fromDate(new Date())
  };
  
  try {
    await updateDoc(doc(db,"visaRequests",editDocId), updatedData);
  
    
    // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù„ÛŒØ³Øª
    const index = allUsers.findIndex(u => u.id === editDocId);
    if (index !== -1) {
      allUsers[index].data = updatedData;
    }
    
    editModal.style.display='none';
    
    // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù†Ù…Ø§ÛŒØ´ Ø¨Ø± Ø§Ø³Ø§Ø³ ÙÛŒÙ„ØªØ± ÙØ¹Ù„ÛŒ
    if (currentFilter === 'recent') {
      await showRecentUsers();
    } else if (currentFilter === 'all') {
      const sortedUsers = [...allUsers].sort((a, b) => {
        const dateA = a.data.timestamp ? a.data.timestamp.toDate() : persianToGregorian(a.data.deliveryDate);
        const dateB = b.data.timestamp ? b.data.timestamp.toDate() : persianToGregorian(b.data.deliveryDate);
        return dateB - dateA;
      });
      displayUsers(sortedUsers, 'Ù‡Ù…Ù‡ Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§', 'all');
    } else if (currentFilter === 'search') {
      searchUsers();
    }
  } catch (error) {
    alert('Ø®Ø·Ø§ Ø¯Ø± ÙˆÛŒØ±Ø§ÛŒØ´ Ø§Ø·Ù„Ø§Ø¹Ø§Øª!');
    console.error(error);
  }
});

// Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø¨Ø§Ù‚ÛŒ Ù…Ø§Ù†Ø¯Ù‡ Ø¯Ø± ÙˆÛŒØ±Ø§ÛŒØ´
editForm.editAmount.addEventListener('input', ()=>{
  editForm.editRemaining.value = (parseFloat(editForm.editAmount.value) || 0) - (parseFloat(editForm.editReceipt.value) || 0);
});
editForm.editReceipt.addEventListener('input', ()=>{
  editForm.editRemaining.value = (parseFloat(editForm.editAmount.value) || 0) - (parseFloat(editForm.editReceipt.value) || 0);
});

// Ø¨Ø³ØªÙ† Ù…ÙˆØ¯Ø§Ù„â€ŒÙ‡Ø§
closeModal.addEventListener('click',()=>qrModal.style.display='none');
closeEditModal.addEventListener('click',()=>editModal.style.display='none');

// Ø¨Ø³ØªÙ† Ù…ÙˆØ¯Ø§Ù„ Ø¨Ø§ Ú©Ù„ÛŒÚ© Ø¨ÛŒØ±ÙˆÙ†
window.addEventListener('click', (e) => {
  if (e.target === qrModal) qrModal.style.display = 'none';
  if (e.target === editModal) editModal.style.display = 'none';
});

// Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ - Ù†Ù…Ø§ÛŒØ´ 10 Ø±ÙˆØ² Ø§Ø®ÛŒØ± Ø¨Ù‡ ØµÙˆØ±Øª Ù¾ÛŒØ´â€ŒÙØ±Ø¶
document.addEventListener('DOMContentLoaded', async () => {
  usersListDiv.innerHTML = '<div class="empty-message">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ 10 Ø±ÙˆØ² Ø§Ø®ÛŒØ±...</div>';
  
  try {
    await loadAllUsers();
    await showRecentUsers(); // Ù†Ù…Ø§ÛŒØ´ 10 Ø±ÙˆØ² Ø§Ø®ÛŒØ± Ø¨Ù‡ ØµÙˆØ±Øª Ù¾ÛŒØ´â€ŒÙØ±Ø¶
  } catch (error) {
    usersListDiv.innerHTML = '<div class="empty-message">Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª. Ù„Ø·ÙØ§ ØµÙØ­Ù‡ Ø±Ø§ Ø±ÙØ±Ø´ Ú©Ù†ÛŒØ¯.</div>';
    console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§ÙˆÙ„ÛŒÙ‡:', error);
  }
});
</script>
</body>
</html>
