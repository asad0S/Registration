<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>سیستم ثبت درخواست ویزا</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
<script src="https://unpkg.com/jalaali-js/dist/jalaali.min.js"></script>
<style>
* {margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;}
body {background:#f8f9fa;color:#333;line-height:1.6;}
.container {width:90%;max-width:900px;margin:2rem auto;padding:1rem;}
h2 {color:#1a5f7a;text-align:center;margin-bottom:1.5rem;}
form {background:white;padding:2rem;border-radius:10px;box-shadow:0 5px 15px rgba(0,0,0,0.05);}
.form-group {margin-bottom:1rem;}
label {display:block;margin-bottom:0.5rem;font-weight:500;color:#444;}
input, textarea {width:100%;padding:0.7rem;border:1px solid #ddd;border-radius:5px;font-size:1rem;}
input:focus, textarea:focus {outline:none;border-color:#1a5f7a;box-shadow:0 0 0 2px rgba(26,95,122,0.1);}
button {background-color:#1a5f7a;color:white;border:none;padding:0.5rem 1rem;font-size:0.9rem;border-radius:5px;cursor:pointer;transition:0.3s;margin-top:5px;}
button:hover {background-color:#154b61;}
.result {margin-top:2rem;text-align:center;}
.qr-container {margin-top:1rem;}
.otp-code {font-size:1.5rem;color:#1a5f7a;font-weight:bold;margin-top:1rem;}
.user-card {border:1px solid #ddd;padding:10px;display:grid;grid-template-columns:1fr 1fr;gap:5px;position:relative;border-radius:5px;cursor:pointer;margin-bottom:10px;}
.user-fullName {grid-column: 1 / -1; margin-top:25px; font-weight:bold;}
.show-qr-btn {position:absolute;top:10px;right:70px;background:#ffcc00;color:#1a5f7a;font-weight:bold;padding:2px 6px;font-size:0.8rem;border-radius:3px;}
.delete-btn {position:absolute;top:10px;right:10px;background:#ff4d4f;color:white;font-weight:bold;padding:2px 6px;font-size:0.8rem;border-radius:3px;}
.modal, .edit-modal {display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);align-items:center;justify-content:center;}
.modal-content, .edit-modal-content {background:white;padding:2rem;border-radius:10px;text-align:center;width:90%;max-width:400px;}
.edit-form {display:flex;flex-direction:column;gap:1rem;}
.edit-form input, .edit-form textarea {width:100%;}
.close-btn {cursor:pointer;background:#1a5f7a;color:white;padding:0.3rem 0.6rem;border:none;border-radius:5px;}
</style>
</head>
<body>
<div class="container">
    <h2>ثبت درخواست ویزا</h2>
    <form id="visaForm">
        <div class="form-group"><label>اسم کامل</label><input type="text" id="fullName" name="fullName" required></div>
        <div class="form-group"><label>اسم پدر</label><input type="text" id="fatherName" name="fatherName" required></div>
        <div class="form-group"><label>مبلغ (افغانی)</label><input type="number" id="amount" name="amount" required></div>
        <div class="form-group"><label>رسید (افغانی)</label><input type="number" id="receipt" name="receipt" required></div>
        <div class="form-group"><label>باقی مانده (افغانی)</label><input type="number" id="remaining" name="remaining" readonly></div>
        <div class="form-group"><label>نوع ویزا</label><textarea id="visaType" name="visaType" placeholder="نوع ویزا را وارد کنید" rows="2" required></textarea></div>
        <div class="form-group"><label>وضیعت فعلی</label><textarea id="status" name="status" placeholder="وضیعت فعلی را بنویسید" rows="2" required></textarea></div>
        <div class="form-group"><label>تاریخ تحویل داده</label><input type="text" id="deliveryDate" name="deliveryDate" readonly></div>
        <button type="submit">ذخیره</button>
    </form>

    <div class="result" id="result">
        <div class="qr-container" id="qrContainer"></div>
        <div class="otp-code" id="otpCode"></div>
    </div>

    <button id="showUsersBtn">اشخاص ثبت شده</button>
    <div id="usersListDiv" style="margin-top:2rem;"></div>
</div>

<div class="modal" id="qrModal">
  <div class="modal-content">
    <canvas id="modalQR"></canvas>
    <button class="close-btn" id="closeModal">بستن</button>
  </div>
</div>

<div class="edit-modal" id="editModal">
  <div class="edit-modal-content">
    <h3 style="color:#1a5f7a;margin-bottom:1rem;">ویرایش اطلاعات</h3>
    <form class="edit-form" id="editForm">
      <input type="text" id="editFullName" required placeholder="اسم کامل">
      <input type="text" id="editFatherName" required placeholder="اسم پدر">
      <input type="number" id="editAmount" required placeholder="مبلغ">
      <input type="number" id="editReceipt" required placeholder="رسید">
      <input type="number" id="editRemaining" readonly placeholder="باقی مانده">
      <textarea id="editVisaType" required rows="2" placeholder="نوع ویزا"></textarea>
      <textarea id="editStatus" required rows="2" placeholder="وضیعت فعلی"></textarea>
      <input type="text" id="editDeliveryDate" readonly placeholder="تاریخ تحویل داده">
      <button type="submit">ذخیره تغییرات</button>
    </form>
    <button class="close-btn" id="closeEditModal">بستن</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, doc, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-analytics.js";

const firebaseConfig = {
  apiKey: "AIzaSyCHjDCV5G4SqXBVayBSQKu0w7ahl-iKK9s",
  authDomain: "search-system-d27b7.firebaseapp.com",
  projectId: "search-system-d27b7",
  storageBucket: "search-system-d27b7.firebasestorage.app",
  messagingSenderId: "928320892642",
  appId: "1:928320892642:web:56263d08783990405738bb",
  measurementId: "G-HBW40SPG7H"
};

const app = initializeApp(firebaseConfig);
const analytics = getAnalytics(app);
const db = getFirestore(app);

// تاریخ شمسی امروز
function getPersianDate(){
  const g = new Date();
  const j = jalaali.toJalaali(g.getFullYear(), g.getMonth()+1, g.getDate());
  return `${j.jy}/${j.jm}/${j.jd}`;
}
document.getElementById('deliveryDate').value = getPersianDate();

const visaForm = document.getElementById('visaForm');
const qrContainer = document.getElementById('qrContainer');
const otpCodeEl = document.getElementById('otpCode');
const usersListDiv = document.getElementById('usersListDiv');
const showUsersBtn = document.getElementById('showUsersBtn');
const qrModal = document.getElementById('qrModal');
const modalQR = document.getElementById('modalQR');
const closeModal = document.getElementById('closeModal');
const editModal = document.getElementById('editModal');
const closeEditModal = document.getElementById('closeEditModal');
const editForm = document.getElementById('editForm');
let editDocId = null;

// محاسبه خودکار باقی مانده
function calculateRemaining(){
  const amount = parseFloat(document.getElementById('amount').value) || 0;
  const receipt = parseFloat(document.getElementById('receipt').value) || 0;
  document.getElementById('remaining').value = amount - receipt;
}
document.getElementById('amount').addEventListener('input', calculateRemaining);
document.getElementById('receipt').addEventListener('input', calculateRemaining);

// ثبت فرم
visaForm.addEventListener('submit', async e=>{
  e.preventDefault();
  const data = {
    fullName: document.getElementById('fullName').value,
    fatherName: document.getElementById('fatherName').value,
    amount: document.getElementById('amount').value,
    receipt: document.getElementById('receipt').value,
    remaining: document.getElementById('remaining').value,
    visaType: document.getElementById('visaType').value,
    status: document.getElementById('status').value,
    deliveryDate: document.getElementById('deliveryDate').value
  };
  const otp = Math.floor(1000 + Math.random()*9000);
  data.otp = otp;

  otpCodeEl.textContent = 'کد OTP شما: ' + otp;
  qrContainer.innerHTML = '';
  const qr = new QRious({element: document.createElement('canvas'), value: JSON.stringify(data), size:200});
  qrContainer.appendChild(qr.element);

  try { await addDoc(collection(db, "visaRequests"), data); alert('اطلاعات با موفقیت ذخیره شد!'); }
  catch(err){ console.error(err); }

  visaForm.reset();
  document.getElementById('deliveryDate').value = getPersianDate();
});

// نمایش کاربران ثبت شده
showUsersBtn.addEventListener('click', async () => {
  usersListDiv.innerHTML = '';
  const snapshot = await getDocs(collection(db, "visaRequests"));
  snapshot.forEach(docSnap => {
    const d = docSnap.data();
    const div = document.createElement('div');
    div.classList.add('user-card');
    div.innerHTML = `
      <button class="show-qr-btn">دیدن بارکد</button>
      <button class="delete-btn">حذف</button>
      <div class="user-fullName">${d.fullName}</div>
      <div><b>اسم پدر:</b></div><div>${d.fatherName}</div>
      <div><b>مبلغ:</b></div><div>${d.amount}</div>
      <div><b>رسید:</b></div><div>${d.receipt}</div>
      <div><b>باقی مانده:</b></div><div>${d.remaining}</div>
      <div><b>نوع ویزا:</b></div><div>${d.visaType}</div>
      <div><b>وضیعت فعلی:</b></div><div>${d.status}</div>
      <div><b>تاریخ تحویل داده:</b></div><div>${d.deliveryDate}</div>
      <div><b>کد OTP:</b></div><div>${d.otp}</div>
    `;
    usersListDiv.appendChild(div);

    div.querySelector('.show-qr-btn').addEventListener('click', ()=>{
      qrModal.style.display='flex';
      new QRious({element:modalQR,value:JSON.stringify(d),size:250});
    });

    div.querySelector('.delete-btn').addEventListener('click', async ()=>{
      if(confirm('آیا مطمئن هستید می‌خواهید حذف شود؟')){
        await deleteDoc(doc(db,"visaRequests",docSnap.id));
        div.remove();
      }
    });

    div.addEventListener('dblclick', ()=>{
      editModal.style.display='flex';
      editForm.editFullName.value=d.fullName;
      editForm.editFatherName.value=d.fatherName;
      editForm.editAmount.value=d.amount;
      editForm.editReceipt.value=d.receipt;
      editForm.editRemaining.value=d.remaining;
      editForm.editVisaType.value=d.visaType;
      editForm.editStatus.value=d.status;
      editForm.editDeliveryDate.value=d.deliveryDate;
      editDocId = docSnap.id;
    });
  });
});

// ذخیره ویرایش
editForm.addEventListener('submit', async e=>{
  e.preventDefault();
  if(!editDocId) return;
  const updatedData = {
    fullName: editForm.editFullName.value,
    fatherName: editForm.editFatherName.value,
    amount: editForm.editAmount.value,
    receipt: editForm.editReceipt.value,
    remaining: editForm.editRemaining.value,
    visaType: editForm.editVisaType.value,
    status: editForm.editStatus.value,
    deliveryDate: editForm.editDeliveryDate.value
  };
  await updateDoc(doc(db,"visaRequests",editDocId), updatedData);
  alert('ویرایش با موفقیت انجام شد!');
  editModal.style.display='none';
  showUsersBtn.click();
});

// بستن مودال‌ها
closeModal.addEventListener('click',()=>qrModal.style.display='none');
closeEditModal.addEventListener('click',()=>editModal.style.display='none');

// محاسبه باقی مانده در ویرایش
editForm.editAmount.addEventListener('input', ()=>{editForm.editRemaining.value = editForm.editAmount.value - editForm.editReceipt.value;});
editForm.editReceipt.addEventListener('input', ()=>{editForm.editRemaining.value = editForm.editAmount.value - editForm.editReceipt.value;});
</script>
</body>
</html>

